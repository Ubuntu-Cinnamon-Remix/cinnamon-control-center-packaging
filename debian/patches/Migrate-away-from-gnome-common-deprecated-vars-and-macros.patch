From: Maximiliano Curia <maxy@gnuservers.com.ar>
Date: Thu, 4 Aug 2016 09:21:15 +0200
Subject: Migrate away from gnome-common deprecated vars and macros

gnome-common is deprecating some vars and macros, listed here:
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=829932

This change follows the gnome recommendations from:
https://wiki.gnome.org/Projects/GnomeCommon/Migration
---
 autogen.sh                          | 45 ++++++++++++++++++++++++-------------
 configure.ac                        |  8 ++++---
 panels/color/Makefile.am            |  5 +++--
 panels/common/Makefile.am           |  3 ++-
 panels/datetime/Makefile.am         |  3 ++-
 panels/display/Makefile.am          |  4 ++--
 panels/network/Makefile.am          |  2 +-
 panels/region/Makefile.am           |  4 ++--
 panels/wacom/Makefile.am            |  6 ++---
 panels/wacom/calibrator/Makefile.am |  6 ++---
 shell/Makefile.am                   |  7 +++---
 11 files changed, 56 insertions(+), 37 deletions(-)

diff --git a/autogen.sh b/autogen.sh
index 7973487..51988b5 100755
--- a/autogen.sh
+++ b/autogen.sh
@@ -1,27 +1,40 @@
 #!/bin/sh
 # Run this to generate all the initial makefiles, etc.
+test -n "$srcdir" || srcdir=$(dirname "$0")
+test -n "$srcdir" || srcdir=.
 
-srcdir=`dirname $0`
-test -z "$srcdir" && srcdir=.
+olddir=$(pwd)
 
-PKG_NAME="cinnamon-control-center"
+cd $srcdir
 
-(test -f $srcdir/configure.ac \
-  && test -f $srcdir/autogen.sh \
-  && test -d $srcdir/shell) || {
-    echo -n "**Error**: Directory "\`$srcdir\'" does not look like the"
-    echo " top-level $PKG_NAME directory"
+(test -f configure.ac) || {
+    echo "*** ERROR: Directory '$srcdir' does not look like the top-level project directory ***"
     exit 1
 }
 
-DIE=0
+# shellcheck disable=SC2016
+PKG_NAME=$(autoconf --trace 'AC_INIT:$1' configure.ac)
 
-rm -f .using-gnome-libs-package
-
-if ! which gnome-autogen.sh ; then
-  echo "You need to install the gnome-common module and make"
-  echo "sure the gnome-autogen.sh script is in your \$PATH."
-  exit 1
+if [ "$#" = 0 -a "x$NOCONFIGURE" = "x" ]; then
+    echo "*** WARNING: I am going to run 'configure' with no arguments." >&2
+    echo "*** If you wish to pass any to it, please specify them on the" >&2
+    echo "*** '$0' command line." >&2
+    echo "" >&2
 fi
 
-. gnome-autogen.sh
+aclocal --install || exit 1
+glib-gettextize --force --copy || exit 1
+gtkdocize --copy || exit 1
+intltoolize --force --copy --automake || exit 1
+autoreconf --verbose --force --install || exit 1
+
+cd "$olddir"
+if [ "$NOCONFIGURE" = "" ]; then
+    $srcdir/configure "$@" || exit 1
+
+    if [ "$1" = "--help" ]; then exit 0 else
+        echo "Now type 'make' to compile $PKG_NAME" || exit 1
+    fi
+else
+    echo "Skipping configure process."
+fi
diff --git a/configure.ac b/configure.ac
index 163f43f..85ef376 100644
--- a/configure.ac
+++ b/configure.ac
@@ -6,10 +6,15 @@ AC_CONFIG_SRCDIR([shell])
 AC_CONFIG_HEADERS([config.h])
 AC_CONFIG_MACRO_DIR([m4])
 
+AX_IS_RELEASE([git-directory])
+
 AM_INIT_AUTOMAKE([1.11 no-dist-gzip dist-xz tar-ustar check-news])
 AM_MAINTAINER_MODE([enable])
 m4_ifdef([AM_SILENT_RULES],[AM_SILENT_RULES([no])])
 
+AX_CHECK_ENABLE_DEBUG([yes])
+AX_COMPILER_FLAGS([WARN_CFLAGS],[WARN_LDFLAGS])
+
 # Check for programs
 AC_PROG_CC
 AM_PROG_CC_C_O
@@ -35,9 +40,6 @@ GETTEXT_PACKAGE=cinnamon-control-center
 AC_SUBST(GETTEXT_PACKAGE)
 AC_DEFINE_UNQUOTED(GETTEXT_PACKAGE, "$GETTEXT_PACKAGE", [Gettext package])
 
-GNOME_DEBUG_CHECK
-GNOME_COMPILE_WARNINGS([maximum])
-
 AC_PATH_XTRA
 x_libs="$X_PRE_LIBS $X_LIBS -lX11 $X_EXTRA_LIBS"
 
diff --git a/panels/color/Makefile.am b/panels/color/Makefile.am
index ca4cbd8..70f7bd3 100644
--- a/panels/color/Makefile.am
+++ b/panels/color/Makefile.am
@@ -2,7 +2,8 @@ SUBDIRS = icons
 
 cappletname = color
 
-INCLUDES = 						\
+AM_CPPFLAGS = 						\
+	$(WARN_CFLAGS)					\
 	$(PANEL_CFLAGS)					\
 	$(COLOR_PANEL_CFLAGS)				\
 	-DCINNAMONCC_UI_DIR="\"$(uidir)\""			\
@@ -20,7 +21,7 @@ libcolor_la_SOURCES =		\
 	cc-color-panel.h
 
 libcolor_la_LIBADD = $(PANEL_LIBS) $(COLOR_PANEL_LIBS)
-libcolor_la_LDFLAGS = $(PANEL_LDFLAGS)
+libcolor_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 uidir = $(pkgdatadir)/ui
 dist_ui_DATA = color.ui
diff --git a/panels/common/Makefile.am b/panels/common/Makefile.am
index 093093e..5491e05 100644
--- a/panels/common/Makefile.am
+++ b/panels/common/Makefile.am
@@ -5,6 +5,7 @@ noinst_LTLIBRARIES = liblanguage.la
 noinst_PROGRAMS = list-languages
 
 AM_CPPFLAGS =						\
+	$(WARN_CFLAGS)					\
 	$(PANEL_CFLAGS)					\
 	$(LIBLANGUAGE_CFLAGS)				\
 	-DDATADIR=\""$(datadir)"\"			\
@@ -26,7 +27,7 @@ liblanguage_la_LIBADD = 		\
 	$(PANEL_LIBS)			    \
 	$(LIBLANGUAGE_LIBS)
 
-liblanguage_la_LDFLAGS = $(PANEL_LDFLAGS)
+liblanguage_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 list_languages_SOURCES = list-languages.c
 list_languages_LDADD = liblanguage.la
diff --git a/panels/datetime/Makefile.am b/panels/datetime/Makefile.am
index 3f284ee..1fc47d0 100644
--- a/panels/datetime/Makefile.am
+++ b/panels/datetime/Makefile.am
@@ -112,6 +112,7 @@ tzdatadir = $(pkgdatadir)/datetime
 dist_tzdata_DATA = backward
 
 AM_CPPFLAGS =						\
+	$(WARN_CFLAGS)					\
 	$(PANEL_CFLAGS)					\
 	$(DATETIME_PANEL_CFLAGS)			\
 	-DCINNAMONLOCALEDIR="\"$(datadir)/locale\""	\
@@ -162,7 +163,7 @@ libdate_time_la_SOURCES =	\
 	tz.c tz.h
 
 libdate_time_la_LIBADD = $(PANEL_LIBS) $(DATETIME_PANEL_LIBS)
-libdate_time_la_LDFLAGS = $(PANEL_LDFLAGS)
+libdate_time_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 @INTLTOOL_DESKTOP_RULE@
 
diff --git a/panels/display/Makefile.am b/panels/display/Makefile.am
index ae27115..57d0c9a 100644
--- a/panels/display/Makefile.am
+++ b/panels/display/Makefile.am
@@ -26,7 +26,7 @@ libdisplay_la_SOURCES =		\
 	$(MARSHALFILES)
 
 libdisplay_la_LIBADD = $(PANEL_LIBS) $(DISPLAY_PANEL_LIBS)
-libdisplay_la_LDFLAGS = $(PANEL_LDFLAGS)
+libdisplay_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 # You will need a recent intltool or the patch from this bug
 # http://bugzilla.gnome.org/show_bug.cgi?id=462312
@@ -49,7 +49,7 @@ desktopdir = $(datadir)/applications
 Desktop_in_files = cinnamon-display-panel.desktop.in
 desktop_DATA = $(Desktop_in_files:.desktop.in=.desktop)
 
-INCLUDES   = $(PANEL_CFLAGS) \
+AM_CPPFLAGS = $(PANEL_CFLAGS) \
 	     $(DISPLAY_PANEL_CFLAGS) \
 	     -DSBINDIR="\"$(sbindir)\"" \
 	     -DUIDIR="\"$(uidir)\"" \
diff --git a/panels/network/Makefile.am b/panels/network/Makefile.am
index 110b927..427bade 100644
--- a/panels/network/Makefile.am
+++ b/panels/network/Makefile.am
@@ -59,7 +59,7 @@ endif
 
 libnetwork_la_LIBADD = $(PANEL_LIBS) $(NETWORK_PANEL_LIBS) $(NETWORK_MANAGER_LIBS) $(builddir)/connection-editor/libconnection-editor.la
 
-libnetwork_la_LDFLAGS = $(PANEL_LDFLAGS)
+libnetwork_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 resource_files = $(shell glib-compile-resources --sourcedir=$(srcdir) --generate-dependencies $(srcdir)/network.gresource.xml)
 cc-network-resources.c: network.gresource.xml $(resource_files)
diff --git a/panels/region/Makefile.am b/panels/region/Makefile.am
index 19942a0..71973f9 100644
--- a/panels/region/Makefile.am
+++ b/panels/region/Makefile.am
@@ -1,7 +1,7 @@
 # This is used in PANEL_CFLAGS
 cappletname = region
 
-INCLUDES =						\
+AM_CPPFLAGS =						\
 	$(PANEL_CFLAGS)					\
 	$(REGION_PANEL_CFLAGS)				\
 	-DLOCALE_DIR="\"$(datadir)/locale\""	\
@@ -26,7 +26,7 @@ libregion_la_SOURCES =	\
 
 libregion_la_LIBADD = $(PANEL_LIBS) $(REGION_PANEL_LIBS) $(builddir)/../common/liblanguage.la
 
-libregion_la_LDFLAGS = $(PANEL_LDFLAGS)
+libregion_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 @INTLTOOL_DESKTOP_RULE@
 
diff --git a/panels/wacom/Makefile.am b/panels/wacom/Makefile.am
index de3c25d..29c2621 100644
--- a/panels/wacom/Makefile.am
+++ b/panels/wacom/Makefile.am
@@ -3,7 +3,7 @@ cappletname = wacom
 
 SUBDIRS = calibrator
 
-INCLUDES = 						\
+AM_CPPFLAGS = 						\
 	$(PANEL_CFLAGS)					\
 	$(WACOM_PANEL_CFLAGS)				\
 	-I$(srcdir)/calibrator				\
@@ -37,7 +37,7 @@ libwacom_properties_la_SOURCES =	\
 	csd-enums.h
 
 libwacom_properties_la_LIBADD = $(PANEL_LIBS) $(WACOM_PANEL_LIBS) $(builddir)/calibrator/libwacom-calibrator.la
-libwacom_properties_la_LDFLAGS = $(PANEL_LDFLAGS)
+libwacom_properties_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 noinst_PROGRAMS = test-wacom
 
@@ -58,7 +58,7 @@ test_wacom_SOURCES =			\
 	csd-input-helper.h		\
 	csd-enums.h
 
-test_wacom_CPPFLAGS = $(INCLUDES)
+test_wacom_CFLAGS = $(AM_CFLAGS)
 test_wacom_LDADD = $(PANEL_LIBS) $(WACOM_PANEL_LIBS) $(builddir)/calibrator/libwacom-calibrator.la
 
 resource_files = $(shell glib-compile-resources --sourcedir=$(srcdir) --generate-dependencies $(srcdir)/wacom.gresource.xml)
diff --git a/panels/wacom/calibrator/Makefile.am b/panels/wacom/calibrator/Makefile.am
index ce70c04..e645583 100644
--- a/panels/wacom/calibrator/Makefile.am
+++ b/panels/wacom/calibrator/Makefile.am
@@ -1,7 +1,7 @@
 # This is used in PANEL_CFLAGS
 cappletname = wacom
 
-INCLUDES = 						\
+AM_CPPFLAGS = 						\
 	$(PANEL_CFLAGS)					\
 	$(WACOM_PANEL_CFLAGS)				\
 	-DCINNAMONLOCALEDIR="\"$(datadir)/locale\""	\
@@ -17,7 +17,7 @@ libwacom_calibrator_la_SOURCES =	\
 	gui_gtk.h
 
 libwacom_calibrator_la_LIBADD = $(PANEL_LIBS) $(WACOM_PANEL_LIBS)
-libwacom_calibrator_la_LDFLAGS = $(PANEL_LDFLAGS)
+libwacom_calibrator_la_LDFLAGS = $(WARN_LDFLAGS) $(PANEL_LDFLAGS)
 
 noinst_PROGRAMS = test-calibrator
 
@@ -28,7 +28,7 @@ test_calibrator_SOURCES =		\
 	gui_gtk.c			\
 	gui_gtk.h
 
-test_calibrator_CPPFLAGS = $(INCLUDES)
+test_calibrator_CFLAGS = $(AM_CFLAGS)
 test_calibrator_LDADD = $(PANEL_LIBS) $(WACOM_PANEL_LIBS)
 
 -include $(top_srcdir)/git.mk
diff --git a/shell/Makefile.am b/shell/Makefile.am
index 6a377fa..b75f9dc 100644
--- a/shell/Makefile.am
+++ b/shell/Makefile.am
@@ -1,4 +1,4 @@
-INCLUDES =					\
+AM_CPPFLAGS =					\
 	-I$(top_srcdir)				\
 	$(SHELL_CFLAGS)
 
@@ -33,7 +33,7 @@ cinnamon_control_center_LDADD =			\
 	libcinnamon-control-center.la		\
 	$(SHELL_LIBS)
 
-cinnamon_control_center_LDFLAGS = -export-dynamic
+cinnamon_control_center_LDFLAGS = $(WARN_LDFLAGS) -export-dynamic
 
 lib_LTLIBRARIES = libcinnamon-control-center.la
 
@@ -53,6 +53,7 @@ libcinnamon_control_center_la_SOURCES =		\
 	$(NULL)
 
 libcinnamon_control_center_la_LDFLAGS =		\
+	$(WARN_LDFLAGS)				\
 	-no-undefined				\
 	-version-info $(LIBCINNAMONCONTROLCENTER_CURRENT):$(LIBCINNAMONCONTROLCENTER_REVISION):$(LIBCINNAMONCONTROLCENTER_AGE) \
 	$(NULL)
@@ -68,7 +69,7 @@ libcinnamon_control_center_includedir = $(includedir)/cinnamon-control-center-1/
 pkgconfigdir=$(libdir)/pkgconfig
 pkgconfig_DATA=libcinnamon-control-center.pc
 
-AM_CPPFLAGS =							\
+AM_CPPFLAGS +=							\
 	-DCINNAMONLOCALEDIR="\"$(datadir)/locale\""		\
 	-DUIDIR="\"$(uidir)\""					\
 	-DMENUDIR="\"$(menudir)\""				\
